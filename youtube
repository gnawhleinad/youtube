#!/bin/bash

pae="--play-and-exit"
repeats=("-R" "--repeat" "-L" "--loop")
yopts=""
for arg in "$@"; do
        if [ "$arg" == "--audio" ]; then
                yopts="--extract-audio --audio-quality 0"
                continue
        fi

        for repeat in $repeats; do
                if [ "$arg" == "$repeat" ]; then
                        pae=""
                        break
                fi
        done
done

OS=$(([[ -f /etc/lsb-release ]] && grep -q -i "Ubuntu" /etc/lsb-release) \
        && echo "ubuntu" || echo "os x")
VLC="cvlc"
if [[ "$OS" == "os x" ]]; then
        VLC="${HOME}/Applications/VLC.app/Contents/MacOS/VLC"
        link=`pbpaste`
else
        link=`xclip -selection clipboard -out`
fi

link=`echo "$link" | grep "youtube.com\|youtu.be"`
if [ -z "$link" ]; then
        echo "A youtube link was not found."
        exit
fi

file=`youtube-dl $yopts --get-filename --output "%(id)s.%(ext)s" "$link"`
file="/var/tmp/"$file
if [ -e $file ]; then
        $VLC $@ $pae --quiet $file &
        exit
fi

youtube-dl $yopts --no-part --output "$file" \
        --exec "$VLC $@ $pae --quiet {} &" "$link"
